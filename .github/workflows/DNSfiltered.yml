name: DNS filtered

on:
  schedule:
    - cron: '15 18 * * *' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  filter-and-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process Rules
        env:
          TZ: 'Asia/Seoul'
        run: |
          download_filter() {
            local URL=$1
            local OUTPUT=$2
            local MAX_RETRIES=3
            local DELAY=60
            local ATTEMPT=1
            local SUCCESS=0
            
            while [ $ATTEMPT -le $MAX_RETRIES ]; do
              curl -sL "$URL" -o "$OUTPUT" || true
              LINES=$(wc -l < "$OUTPUT" || echo 0)
              
              if [ "$LINES" -ge 10000 ]; then
                SUCCESS=1
                break
              else
                if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                  sleep $DELAY
                fi
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
            
            if [ $SUCCESS -eq 0 ]; then
              echo "CRITICAL_FAILURE=true" >> $GITHUB_ENV
              return 1
            fi
            return 0
          }
          
          download_filter "https://filters.adtidy.org/windows/filters/15.txt" "original.txt"
          
          if [ "$CRITICAL_FAILURE" == "true" ]; then
            exit 1
          fi

          awk '
          /^[!#]/ { next }
          /^\s*$/ { next }
          
          /^@@/ {
              content = substr($0, 3)
              if (content !~ /^\|/ || content ~ /\*/ || content ~ /\//) {
              } else {
                  next
              }
          }

          {
              if ($0 ~ /\$badfilter$/ || $0 ~ /\|$/) {
                  print $0
              } else if ($0 ~ /\$important/) {
                  print $0 ",all"
              } else {
                  print $0 "$all"
              }
          }
          ' original.txt > "DNS filtered.txt"
          
          LINE_COUNT=$(grep -cve '^\s*$' "DNS filtered.txt" || true)
          
          if [ "$LINE_COUNT" -gt 1000 ]; then
            > "DNS filtered.txt"
          fi
          
          rm original.txt

      - name: Deploy to Isolate Branch
        if: success()
        run: |
          mkdir -p /tmp/filter_output
          mv "DNS filtered.txt" /tmp/filter_output/
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin Isolate || true
          
          if git show-ref --verify --quiet refs/remotes/origin/Isolate; then
             git checkout Isolate
             git pull origin Isolate --rebase
          else
             git checkout --orphan Isolate
             git rm -rf .
          fi
          
          mv /tmp/filter_output/"DNS filtered.txt" .
          git add "DNS filtered.txt"
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Auto update DNS filtered rules: $(date +'%Y-%m-%d %H:%M:%S') KST"
            git push origin Isolate
          fi
